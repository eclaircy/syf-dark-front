<template>
    <div id="group-graph" style=""> </div>
</template>

<style scoped>
.group-graph{
    display:flex;
    scrollWidth:760px; 
    scrollHeight:400px;
}

</style>
<script>
import insertCss from 'insert-css';
import G6 from '@antv/g6';
export default {
    props:["graphData"],

    data(){
        return{
            
        }
    },
    watch: {
        graphData: function(newVal, oldVal) {
        // 当 graphData 数据变化时执行渲染的逻辑
            this.show();
        }
    },
    methods: {
        show(){
            var data = this.graphData
            const containerId = "group-graph"
            const graphDiv = document.getElementById(containerId);
            const container = document.getElementById(containerId);
            const width = container.scrollWidth ||760;
            const height = container.scrollHeight ||400; //TODO:原本为450，这里修改画布的高度
            
            const canvasBackgroundColor = '#363b40';
            const darkBackColor = 'rgb(43, 47, 51)'; //TODO:这里修改节点的背景颜色 原本rgb(43, 47, 51)
            // container.style.backgroundColor = canvasBackgroundColor; //TODO:背景颜色?
            const nodeSize =20;
            const linkDistance = 100; //边的长度
            const nodeStrength = -20; //节点斥力
            const clusterNode = ["Website","Company","Person","Ip","Redirect"];
            const clusterEdge = ["BELONGS_TO","DOWNLOAD_FROM","HAS_IP","HAS_COMPANY"];
            //TODO:修改url
            // fetch('api/graph/all/limit?limit=50') 
            // .then((res) => res.json())
            // .then((data) => {
                // this.graph = data;
                
                const subjectColors = [
                    '#5F95FF', // blue
                    '#61DDAA',
                    '#65789B',
                    '#F6BD16',
                    '#7262FD',
                    '#78D3F8',
                    '#9661BC',
                    '#F6903D',
                    '#008685',
                    '#F08BB4',
                ];
                const backColor = '#fff';//TODO:'#fff'
                const theme = 'default';
                const disableColor = '#777';
                const colorSets = G6.Util.getColorSetsBySubjectColors(
                    subjectColors,
                    // darkBackColor,
                    backColor,
                    theme,
                    disableColor,
                );

                //3、分类
                // const clusterNode = ["Domain","Company","Person","Ip","Cert"];
                const clusterNodeIcon = {

                }
                data.nodes.forEach(function (node) {
                    const cid = clusterNode.indexOf(node.label);
                    node.legendType=node.label;
                    if (!node.style) {
                        node.style = {};
                    }
                    node.style.fill = colorSets[cid].mainStroke; //subjectColors
                    node.style.stroke = colorSets[cid].mainStroke; //strokes[cid % strokes.length];
                });
                
                // const clusterEdge = ["IS_SUB","FOUNDED_BY","HAS_IP","WORKS_FOR","HAS_CERT"];
                data.edges.forEach(edge => {
                    const cid = clusterEdge.indexOf(edge.label);
                    edge.legendType=edge.label;
                    edge.style = {
                        stroke: colorSets[cid].mainStroke  //colorSets[cid].mainStroke,
                    };
                    edge.color = colorSets[cid].mainStroke;  //设置边的颜色
                    edge.label=null;
                })


                var legendConfig = {}; 
                const nodeLegendSize = 15;
                var legendData = {}
                legendData.nodes = [];
                legendData.edges = [];
                var filterFunctions = {};
                clusterNode.forEach(element => {
                    const cid = clusterNode.indexOf(element);
                    var nodeLegendConfig = {};
                    nodeLegendConfig["r"]=nodeLegendSize; //图例节点的大小
                    nodeLegendConfig["style"] = {
                        "fill":colorSets[cid].mainStroke,
                        "stroke":colorSets[cid].mainStroke //设置这个，不然node的边框会变成蓝色
                    };
                    legendConfig[element]=nodeLegendConfig;

                    legendData.nodes.push({
                        id:element,
                        label:element,
                        ...legendConfig[element]
                    })
                    filterFunctions[element] = (d)=>{if (d.legendType === element) return true;return false}
                });

                clusterEdge.forEach(element=>{
                    const cid = clusterEdge.indexOf(element);
                    var edgeLegendConfig = {};
                    edgeLegendConfig["type"]="line"; //图例节点的大小
                    edgeLegendConfig["style"]={"stroke":colorSets[cid].mainStroke,"width":20};
                    legendConfig[element]=edgeLegendConfig;

                    legendData.edges.push({
                        id: element,
                        label: element,
                        ...legendConfig[element]
                    })
                    filterFunctions[element] = (d)=>{if (d.legendType === element) return true;return false}
                })
                console.log(filterFunctions)
                // const legend = new G6.Legend({
                //     data: legendData,
                //     align: 'center',
                //     layout: 'vertical', // vertical  图标水平或竖直  horizontal
                //     position: 'bottom-left',  //TODO: 图标的位置原本为bottom-left
                //     vertiSep: 10, //12竖直间距
                //     horiSep: 20, //图例间的水平间距
                //     offsetX: 10, //图例区域离 position 对应的默认位置的 x 方向的偏移量，可被用于图例位置的微调
                //     offsetY: -10,
                //     padding: [12, 4, 8, 16], //图例区域内部内容到边框的距离，四位数组分别代表上、右、下、左边距
                //     containerStyle: {
                //         fill: '#ccc',
                //         lineWidth: 1
                //     },
                //     title: '',
                //     titleConfig: {
                //         position: 'center',
                //         offsetX: 0,
                //         offsetY: 12,
                //     },
                //     filter: {
                //         enable: true,
                //         trigger: 'mouseenter',
                //         graphActiveState: 'activeByLegend',
                //         graphInactiveState: 'inactiveByLegend',
                //         filterFunctions: filterFunctions
                //     }
                // });

                //tooltip 悬浮提示框
                const tooltip = new G6.Tooltip({
                    offsetX: 10,
                    offsetY: 10,
                    // the types of items that allow the tooltip show up
                    // 允许出现 tooltip 的 item 类型
                    itemTypes: ['node', 'edge'],
                    // custom the tooltip's content
                    // 自定义 tooltip 内容
                    getContent: (e) => {
                        const outDiv = document.createElement('div');
                        outDiv.style.width = 'fit-content';
                        //outDiv.style.padding = '0px 0px 20px 0px';
                        // <ul>
                        //     <li>节点类型:${e.item.getType()}</li>
                        // </ul>
                        if(e.item.getType()=="node"){
                            outDiv.innerHTML = `
                            <h4>节点信息</h4>
                            <ul>
                                <li>节点id:<button style="font-weight: bold;"> ${e.item.getModel().id}</button></li>
                            </ul>
                            <ul>
                                <li>节点类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                            </ul>
                            <ul>
                                <li>节点名称: ${e.item.getModel().properties["name"] || e.item.getModel().id}</li>
                            </ul>
                        `;
                        }
                        return outDiv;
                    },
                });
                const graph = new G6.Graph({
                    container: containerId,
                    width,   
                    height,
                    // fitView:true, 别开最好
                    //TODO:注意 fitCenter和layout中的center只选择一个
                    // fitCenter: true,
                    // linkCenter: true,
                    modes: {
                        default: ['drag-canvas', 'activate-relations', 'zoom-canvas']
                        // default: ['drag-node'],
                    },
                    layout: {
                        type: 'force',
                        linkDistance: 80, //边的长度 180
                        preventOverlap: true,
                        // nodeStrength: nodeStrength,  //节点的引力，负数代表斥力
                        center: [width / 2, height / 2],// 可选，默认为图的中心
                        nodeStrength: (d) => {
                        if (d.isLeaf) {
                            return -50;
                        }
                        return -90;
                        },
                        
                    },
                    // layout:{
                    //     type: 'radial',
                    //     unitRadius: 50,
                    //     preventOverlap: true,
                    //     // maxPreventOverlapIteration: 100,
                    // },
                    defaultNode: {
                        size: nodeSize,
                        type: 'circle',
                        style: {
                            lineWidth: 2,
                        },
                        labelCfg: {
                            position: 'bottom',
                        },
                        icon: {
                            show: true,
                            img: 'https://gw.alipayobjects.com/zos/basement_prod/012bcf4f-423b-4922-8c24-32a89f8c41ce.svg',
                            /* icon's size, 20 * 20 by default: */
                            //   width: 40,
                            //   height: 40
                        },
                    },
                    defaultEdge: {
                        style:{  //TODO:可以修改箭头的样式  https://g6.antv.antgroup.com/manual/middle/elements/edges/arrow
                            endArrow:true
                        },
                    },
                    nodeStateStyles: {
                        activeByLegend: {
                            lineWidth: 10,
                            strokeOpacity: 0.5
                        },
                        inactiveByLegend: {
                            
                        },
                        active: {
                            lineWidth: 10,
                            strokeOpacity: 0.5
                        },
                    },
                    edgeStateStyles: {
                        activeByLegend: {
                            lineWidth: 3
                        },
                        inactiveByLegend: {
                            opacity: 0.5
                        }
                    },
                    animate: true,
                    plugins: [tooltip],
                });
                graph.data({
                    nodes: data.nodes,
                    edges: data.edges.map(function (edge, i) {
                        edge.id = 'edge' + i;
                        return Object.assign({}, edge);
                    }),
                });
                graph.render();

                graph.on('node:dragstart', function (e) {
                    graph.layout();
                    refreshDragedNodePosition(e);
                });
                graph.on('node:drag', function (e) {
                    const forceLayout = graph.get('layoutController').layoutMethods[0];
                    forceLayout.execute();
                    refreshDragedNodePosition(e);
                });
                graph.on('node:dragend', function (e) {
                    e.item.get('model').fx = null;
                    e.item.get('model').fy = null;
                });

                if (typeof window !== 'undefined')
                window.onresize = () => {
                    if (!graph || graph.get('destroyed')) return;
                    if (!container || !container.scrollWidth || !container.scrollHeight) return;
                    graph.changeSize(container.scrollWidth, container.scrollHeight);
                };
            // });

            function refreshDragedNodePosition(e) {
                const model = e.item.get('model');
                model.fx = e.x;
                model.fy = e.y;
            }
        },
        showCon(){
            
            const graphDiv = document.getElementById('group-graph');
            const descriptionDiv = document.createElement('div');
            descriptionDiv.innerHTML =
            'Constrians the nodes to be layed in the gray area with force-directed layout';
            graphDiv.appendChild(descriptionDiv);

            const container = document.getElementById('group-graph');
            const width = container.scrollWidth;
            const height = container.scrollHeight || 500;

            fetch('https://gw.alipayobjects.com/os/antvdemo/assets/data/relations.json')
            .then((res) => res.json())
            .then((data) => {
                const nodes = data.nodes;

                // 灰色区域
                const constrainBox = { x: 60, y: 50, width: 500, height: 150 };

                const backrect = document.createElement('div');
                backrect.style.backgroundColor = '#666';
                backrect.style.opacity = 0.1;
                backrect.style.marginLeft = `${constrainBox.x}px`;
                backrect.style.marginTop = `${constrainBox.y}px`;
                backrect.style.width = `${constrainBox.width}px`;
                backrect.style.height = `${constrainBox.height}px`;
                backrect.style.position = 'absolute';
                graphDiv.appendChild(backrect);

                const onTick = () => {
                let minx = 99999999;
                let maxx = -99999999;
                let miny = 99999999;
                let maxy = -99999999;
                let maxsize = -9999999;
                nodes.forEach((node) => {
                    if (minx > node.x) {
                    minx = node.x;
                    }
                    if (maxx < node.x) {
                    maxx = node.x;
                    }
                    if (miny > node.y) {
                    miny = node.y;
                    }
                    if (maxy < node.y) {
                    maxy = node.y;
                    }
                    if (maxsize < node.size) {
                    maxsize = node.size;
                    }
                });
                const scalex = (constrainBox.width - maxsize) / (maxx - minx);
                const scaley = (constrainBox.height - maxsize) / (maxy - miny);
                nodes.forEach((node) => {
                    node.x = (node.x - minx) * scalex + constrainBox.x;
                    node.y = (node.y - miny) * scaley + constrainBox.y;
                });
                };

                const graph = new G6.Graph({
                container: 'group-graph',
                width,
                height,
                layout: {
                    type: 'force',
                    onTick,
                },
                defaultNode: {
                    size: 15,
                },
                });

                graph.data({
                nodes: data.nodes,
                edges: data.edges.map(function (edge, i) {
                    edge.id = 'edge' + i;
                    return Object.assign({}, edge);
                }),
                });
                graph.render();

                if (typeof window !== 'undefined')
                window.onresize = () => {
                    if (!graph || graph.get('destroyed')) return;
                    if (!container || !container.scrollWidth || !container.scrollHeight) return;
                    graph.changeSize(container.scrollWidth, container.scrollHeight);
                };
            });

        }
    },
    mounted(){
    //    
    },

}
</script>