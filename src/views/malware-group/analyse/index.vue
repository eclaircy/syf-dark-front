<template>
    <div class="page-container">
        <el-row>
            <el-card>
                 <div style="font-size: 20px;margin-bottom: 7px;">团伙挖掘与分析</div>
                 <span>追踪团伙构成恶意下载网站、背后公司组成、涉及人员</span>
                 <el-button style="margin-left:30px;">当前团伙：{{ cid }}</el-button>
                 <el-divider></el-divider>
            </el-card>
        </el-row>

        <el-row>
            <el-card>
                <MyPanelCard header="相关网站" countNumber="21" style="margin-right:20px"/>
                <MyPanelCard header="相关公司" countNumber="14" style="margin-right:20px"/>
                <MyPanelCard header="相关人员" countNumber="14" style="margin-right:20px"/>
                <MyPanelCard header="相关IP" countNumber="21" style="margin-right:20px"/>
                <MyPanelCard header="跳转链接" countNumber="31" style="margin-right:20px"/>
            </el-card>
        </el-row>

        <el-row :gutter=1>
            <!-- 中央 -->
            <el-col :span="15">
                <MyCard class="main-graph" header="团伙知识图谱">
                    <div class="card-body">
                        <GroupGraph :graphData="graphData" :cid="cid"/>
                    </div>
                </MyCard>
            </el-col>
            <!-- 最右侧 -->
            <el-col :span="9">
                <MyCard class="find-path" header="链路追踪">
                    <div class="card-body">
                        <FindPath  :graphData="graphData" style="margin:10px" />
                    </div>
                </MyCard>
            </el-col>
        </el-row>

        <el-row :gutter=2>
            <el-col :span="8">
                <MyCard header="团伙监控动态" class="timeline-container">
                    <div class="card-body">
                        <el-scrollbar style="height:360px;" wrap-style="overflow-x:hidden;"> 
                            <a-timeline mode="alternate" style="margin-top:5px;">
                                <a-timeline-item>团伙id-3</a-timeline-item>
                                <a-timeline-item color="green">
                                    新增网站 
                                    
                                    <div><b>2015-09-01</b></div>
                                </a-timeline-item>
                                <a-timeline-item  color="green">
                                    新增公司 
                                    
                                    <div><b>2015-09-01</b></div>
                                </a-timeline-item>
                                <a-timeline-item color="red">
                                    新增可疑人员 
                                    
                                    <div><b>2015-09-01</b></div>
                                </a-timeline-item>
                                <a-timeline-item>
                                    新增网站 
                                    
                                    <div><b>2015-09-01</b></div>
                                </a-timeline-item>
                                <a-timeline-item  color="green">
                                    新增公司
                                    
                                </a-timeline-item>
                                <a-timeline-item  color="green">
                                    新增公司
                                    
                                </a-timeline-item>
                                <a-timeline-item  color="green">
                                    新增公司
                                    
                                </a-timeline-item>
                                <a-timeline-item  color="green">
                                    新增公司
                                    
                                </a-timeline-item>
                            </a-timeline>
                        </el-scrollbar>
                    </div>
                </MyCard>
            </el-col>

            <el-col :span="16">
                <MyCard header="团伙成员" class="tab-table">
                    <el-tabs type="border-card">
                        <el-tab-pane label="统计信息">
                            <NodeCountPie :nodeCount="nodeCount" style="height: 300px;"/>
                        </el-tab-pane>
                        <el-tab-pane label="组成网站">
                            <NodeTable :graphData="graphData"/>
                        </el-tab-pane>
                        <el-tab-pane label="组成公司">
    
                        </el-tab-pane>
                        <el-tab-pane label="组成人员">
    
                        </el-tab-pane>
                        <el-tab-pane label="IP">
    
                        </el-tab-pane>
                        <el-tab-pane label="下载链接">
    
                        </el-tab-pane>
                    </el-tabs>
                </MyCard>

                
            </el-col>
        </el-row>


        <!-- <el-row>
            <el-col :span="16">
                <MyCard class="right-bottom" header="关键资产" style="height:450px">
                    <div class="card-body">
                      <NodePageRank :graphData="graphData"  style="margin-top:30px"/>
                    </div>
                </MyCard>
            </el-col>
        </el-row> -->

        <el-row :gutter="2">
            <MyCard class="right-bottom" header="团伙成员重要性">
                <div class="card-body">
                    <el-col :span="15">
                        <!-- <div id="page-rank-container"  style="width:520px;height:300px"></div> -->
                        <NodePageRank :pageRank="pageRank"  style="height:340px;margin-top:30px"/>
                    </el-col>
                    
                    <el-col :span="9">
                        <div style="padding:20px">
                        <div style="color:rgb(218, 218, 218);margin-bottom:25px;">关键成员排名</div>
                        <div v-for="(item,index) in pageRank.slice(0,8)" style="margin-top:10px">
                            <el-row>
                                <el-col :span="2">
                                    <a-badge :count="index+1" :number-style="{ backgroundColor: 'purple',color: '#fff',boxShadow: '0 0 0 1px purple inset',}" style="margin-right:10px;"/>
                                </el-col>
                                <el-col :span="6">
                                    <el-tag round class="custom-button" type="primary" size="mini"
                                    v-bind:style="{ backgroundColor: item.color,borderColor:item.color }">{{item.label}}</el-tag>
                                </el-col>
                                <el-col :span="13">
                                    <span>{{ item.nodeName }} </span>
                                </el-col>
                                <el-col :span="3">
                                    <span style="display:inline-block;float:right">{{ item.pageRankValue.toFixed(3) }}</span>
                                </el-col>
                            </el-row>
                            <!-- <a-badge :count="index+1" :number-style="{ backgroundColor: 'purple',color: '#fff',boxShadow: '0 0 0 1px purple inset',}" style="margin-right:10px;"/>
                            <el-tag round class="custom-button" type="primary" size="mini"
                                v-bind:style="{ backgroundColor: item.color,borderColor:item.color }">{{item.label}}</el-tag>
                            <span>{{ item.nodeName }} </span>
                           <span style="display:inline-block;float:right">{{ item.pageRankValue.toFixed(3) }}</span> -->
                            </div>
                        </div>
                    </el-col>
                </div>
            </MyCard>
        </el-row>
        <el-row>
            <el-col :span="12">
                <!-- <GroupSankey :graphData="graphData"/> -->
            </el-col>
            <el-col :span="12">
                <!-- <GroupChord :graphData="graphData"/> -->
            </el-col>
        </el-row>
    
    </div>
</template>
<!-- height:px -->
<script>
import MyCard from "./component/MyCard"
import NodeTable from "./component/NodeTable"
import NodePageRank from "./component/NodePageRank"
import GroupSankey from "./component/GroupSankey"
import GroupTable from "./component/GroupTable"
import FindPath from "./component/FindPath"
import GroupGraph from "./component/GroupGraph.vue"
import NodeCountPie from "./component/NodeCountPie.vue"
import GroupChord from "./component/GroupChord.vue"
import GroupCircle from "./component/GroupCircle.vue"
import MyPanelCard from "./component/MyPanelCard.vue"
import { Column } from '@antv/g2plot';
import { pageRank } from "@antv/algorithm";

export default {
    data() {
        return {
            graphData:'',
            nodeCount:[],
            cid:'',
            pageRank:'',
            subjectColors :[
                '#5F95FF', // blue
                '#61DDAA',
                '#65789B',
                '#F6BD16',
                '#7262FD',
                '#78D3F8',
                '#9661BC',
                '#F6903D',
                '#008685',
                '#F08BB4',
            ],
        }
    },
    components:{
        MyCard,
        NodeTable,
        NodePageRank,
        GroupSankey,
        GroupTable,
        FindPath,
        GroupGraph,
        NodeCountPie,
        GroupChord,
        GroupCircle,
        MyPanelCard
    },
    methods: {
        getGroupData(cid){
            // var cid =3;
            // fetch('api/graph/domain?'+"dname="+"hongpig.com"+"&depth="+3) 
            fetch('api/graph/cluster/'+cid) 
            .then((res) => res.json())
            .then((data) => {
                // this.graphData = data;
                this.countNode(data)
                this.graphData = this.jsonData(data)
                this.showPageRank(data)
            })
        },
        countNode(graphData){
            var nodeCount = {}
            graphData.nodes.forEach(node => {
                if(!(node.label in nodeCount)){
                    nodeCount[node.label] = 0; 
                }
                nodeCount[node.label] += 1; 
            });
            const result = Object.entries(nodeCount).map(([type, value]) => {
                return { type, value };
            });
            this.nodeCount = result;
            console.log(result);
        },
        jsonData(data) {
            const nodeIds = new Set(data.nodes.map(node => node.id));
            const parentIds = new Set(data.edges.map(edge => edge.source));
            const leafIds = new Set([...nodeIds].filter(id => !parentIds.has(id)));

            const result = {
                nodes: data.nodes.map(node => {
                if (leafIds.has(node.id)) {
                    return { ...node, isLeaf: true };
                } else {
                    return node;
                }
                }),
                edges: data.edges
            };
            console.log(result)
            return result
            // return JSON.stringify(result, null, 2);
        },
        showPageRank(graph){
            let rankResult = pageRank(graph); //return Object[id: pagerank] 
            console.log(rankResult);
            const data = []
            for(var key in rankResult){
                if(key!=="c"){
                var nodeName;
                var nodeType;
                var label;
                graph.nodes.forEach(node => {
                    if(node["id"]==key){
                        nodeName = node.properties["name"] || "";
                        label = node.label;
                        // nodeType = node.label;
                    }
                });
                data.push({
                    nodeId:key,
                    nodeName: nodeName,
                    pageRankValue: rankResult[key],
                    label:label,
                    color:"#7262FD",
                    // nodeType: nodeType,
                })}
            } 
            console.log(data)
            const result = data.sort((a, b) => b.pageRankValue - a.pageRankValue);
            // this.show(result.slice(0, 6))
            console.log('res',result)
            this.pageRank=result;
        },
    },
    created(){
        this.cid = this.$route.query.id;
        this.getGroupData(this.cid)
    },
    // mounted(){
    //     this.getGroupData()
    // },
    computed: {
       
  }
}
</script>

<style lang="css" scoped>
    /deep/.el-row{
        margin-bottom: 2px;
    }
    /**.custom-button{
        color:black;font-size:13px;
    }**/
    .custom-button{
        color: #fff;font-size:12px;font-weight:400
    }
    .page-container{
        padding: 1px;
        margin-bottom:20px;
    }
    /*中间*/
    .main-graph{
        height: 440px;
    }
    /*左侧*/
    .left-upper{
        height: 120px;
    }
    .left-middle{
        height: 320px;
    }
    /*右侧*/
    .right-upper{
        height: 440px;
    }
    /*底部高度*/
    .find-path{
        height: 440px;
    }
    .graph-bottom{
        height: 400px;
    }
    .right-bottom{
        height: 425px;
    }

   
    .timeline-card{
        height:430px;
    }

    .timeline-container{
        padding: 5px;
        height:430px;
    }
    .tab-table{
        height:430px;
    }

    .ant-timeline-item{
    color: #fff;
    }


    /deep/.el-card {
        border-radius: 4px;
        border: 1px solid transparent;
    }

    /deep/.el-tabs--border-card {
        background: #343A40;
        border: 1px solid transparent;
    }
    /deep/.el-tabs--border-card > .el-tabs__content {
        padding: 25px;
    }
    /deep/.el-tabs--border-card > .el-tabs__header .el-tabs__item.is-active {
        color: #00adff;
        background-color: #343940;
        border-right-color: #121820;
        border-left-color: #121820;
    }
    
</style>

