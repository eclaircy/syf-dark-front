<template>
    <div class="page-container">
        <el-row :gutter=1>
             <!-- 最左侧 -->
            <el-col :span="5">
                <MyCard class="right-upper" header="节点列表信息">
                    <div class="card-body">
                        <!-- 节点类型统计 -->
                        <div style="margin-bottom:10px;margin-top:0px;">
                            <NodeCountPie :nodeCount="nodeCount" style="height: 130px;"/>
                            <!-- <NodeCountColumn/> -->
                        </div>
                        <!-- TODO:搜索框 -->
                        <NodeTable :graphData="graphData"/>
                        <!-- TODO:分页表格 -->
                    </div>
                </MyCard>
            </el-col>
            <!-- 中央 -->
            <el-col :span="14">
                <MyCard class="main-graph" header="团伙图谱">
                    <div class="card-body">
                        <GroupGraph :graphData="graphData"/>
                    </div>
                </MyCard>
            </el-col>
            <!-- 最右侧 -->
            <el-col :span="5">
                <MyCard class="left-upper" header="团伙统计信息">
                    <div class="card-body">
                        <!-- table:节点数量、边数量、团伙id -->
                    <el-button round class="custom-button" type="primary" size="small" style="background-color:#FAF7FC;border-color:#9661BC">
                        节点数：{{  }}
                    </el-button>
                    <el-button round class="custom-button" type="primary" size="small" style="background-color:#FEF8E8;border-color:#F7C227">
                        边数：{{  }}
                    </el-button>
                    <el-button round class="custom-button" type="primary" size="small" style="background-color:;border-color:">
                        团伙id:5
                    </el-button>
                    </div>
                </MyCard>
                <MyCard class="left-middle" header="团伙列表">
                    <div class="card-body">
                        <!-- TODO: 显示当前团伙id -->
                        <GroupTable/>
                    </div>
                </MyCard>
            </el-col>
        </el-row>

        <el-row :gutter=1>
            <el-col :span="7">
                <MyCard class="left-bottom" header="节点路径查询">
                    <div class="card-body">
                        <FindPath  :graphData="graphData" />
                    </div>
                </MyCard>
            </el-col>
            <el-col :span="10">
                <MyCard class="graph-bottom" header="弦图">
                    <div class="card-body">
                        <!-- <GroupSankey :graphData="graphData" />     -->
                        <GroupChord :graphData="graphData" />
                        <!-- <GroupCircle :graphData="graphData"/> -->
                    </div>
                </MyCard>
            </el-col>
            <el-col :span="7">
                <MyCard class="right-bottom" header="关键资产">
                    <div class="card-body">
                      <NodePageRank :graphData="graphData"  style="height:250px;margin-top:30px"/>
                    </div>
                </MyCard>
            </el-col>
        </el-row>
    </div>
</template>
<!-- height:px -->
<script>
import MyCard from "./component/MyCard"
import NodeTable from "./component/NodeTable"
import NodePageRank from "./component/NodePageRank"
import GroupSankey from "./component/GroupSankey"
import GroupTable from "./component/GroupTable"
import FindPath from "./component/FindPath"
import GroupGraph from "./component/GroupGraph.vue"
import NodeCountPie from "./component/NodeCountPie.vue"
import GroupChord from "./component/GroupChord.vue"
import GroupCircle from "./component/GroupCircle.vue"


export default {
    data() {
        return {
            graphData:[],
            nodeCount:[]
        }
    },
    components:{
        MyCard,
        NodeTable,
        NodePageRank,
        GroupSankey,
        GroupTable,
        FindPath,
        GroupGraph,
        NodeCountPie,
        GroupChord,
        GroupCircle
    },
    methods: {
        getGroupData(){
            fetch('api/graph/domain?'+"dname="+"hongpig.com"+"&depth="+3) 
            .then((res) => res.json())
            .then((data) => {
                // this.graphData = data;

                this.countNode(data)
                this.graphData = this.jsonData(data)
            })
        },
        countNode(graphData){
            var nodeCount = {}
            graphData.nodes.forEach(node => {
                if(!(node.label in nodeCount)){
                    nodeCount[node.label] = 0; 
                }
                nodeCount[node.label] += 1; 
            });
            const result = Object.entries(nodeCount).map(([type, value]) => {
                return { type, value };
            });
            this.nodeCount = result;
            console.log(result);
        },
        jsonData(data) {
        const nodeIds = new Set(data.nodes.map(node => node.id));
        const parentIds = new Set(data.edges.map(edge => edge.source));
        const leafIds = new Set([...nodeIds].filter(id => !parentIds.has(id)));

        const result = {
            nodes: data.nodes.map(node => {
            if (leafIds.has(node.id)) {
                return { ...node, isLeaf: true };
            } else {
                return node;
            }
            }),
            edges: data.edges
        };
        console.log(result)
        return result
        // return JSON.stringify(result, null, 2);
        }
    },
    mounted(){
        this.getGroupData()
       
        
    },
    computed: {
       
  }
}
</script>

<style lang="css" scoped>

    .custom-button{
        color:black;font-size:13px;
    }
    .page-container{
        padding: 1px;
    }
    /*中间*/
    .main-graph{
        height: 440px;
    }
    /*左侧*/
    .left-upper{
        height: 120px;
    }
    .left-middle{
        height: 320px;
    }
    /*右侧*/
    .right-upper{
        height: 440px;
    }
    /*底部高度*/
    .left-bottom{
        height: 400px;
    }
    .graph-bottom{
        height: 400px;
    }
    .right-bottom{
        height: 400px;
    }

   

    
</style>

