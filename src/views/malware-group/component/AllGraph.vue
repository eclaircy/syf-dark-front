<template>
    <div id="all-container" class="graph-container1"></div>
</template>

<script>
import G6 from '@antv/g6';
import insertCss from 'insert-css';
import { array } from 'jszip/lib/support';
export default {
    data() {
        return {
            graph:'',
        }
    },
    methods: {
        show(){
            const container = document.getElementById('all-container');
            const width = container.scrollWidth ||300;
            const height = container.scrollHeight || 600; //这里修改画布的高度
            insertCss(`
            .g6-component-tooltip {
                background-color: rgba(255, 255, 255, 0.8);
                padding: 0px 10px 24px 10px;
                box-shadow: rgb(174, 174, 174) 0px 0px 10px;
            }
            `);
            ////https://gw.alipayobjects.com/os/antvdemo/assets/data/relations.json
            ///TODO:现在数据库还没建立起来，所以无法通过域名名称查到对应的图谱。
            //api/graph/domain?dname=example.com1&depth=2
            //真正的请求'api/graph/domain?'+"dname="+this.siteInfo.domain+"&depth="+depth
            //测试请求api/graph/test 最初的测试api，数据写死    http://localhost:8888/graph/test
            fetch('api/graph/all') 
            .then((res) => res.json())
            .then((data) => {
                this.graph = data;
                console.log(data)
                const subjectColors = [
                    '#5F95FF', // blue
                    '#61DDAA',
                    '#65789B',
                    '#F6BD16',
                    '#7262FD',
                    '#78D3F8',
                    '#9661BC',
                    '#F6903D',
                    '#008685',
                    '#F08BB4',
                ];
                const backColor = '#fff';
                const theme = 'default';
                const disableColor = '#777';
                const colorSets = G6.Util.getColorSetsBySubjectColors(
                    subjectColors,
                    backColor,
                    theme,
                    disableColor,
                );

                //1、PageRank算法结果展示
                // let result = pageRank(data); //return Object[id: pagerank] 
                // this.showPageRankColumn(result);
                // console.log(result);
                //2、桑基图
                // this.showSanky(data.edges);

                //3、分类
                const clusterMap = new Map();
                let clusterId = 0;
                data.nodes.forEach(function (node) {
                    // cluster
                    if (node.label && clusterMap.get(node.label) === undefined) {
                        clusterMap.set(node.label, clusterId);
                        clusterId++;
                    }
                    node.legendType=node.label;
                    const cid = clusterMap.get(node.label);
                    if (!node.style) {
                        node.style = {};
                    }
                    node.style.fill = colorSets[cid].mainFill; //subjectColors
                    node.style.stroke = colorSets[cid].mainStroke; //strokes[cid % strokes.length];

                });
                
                const clusterEdgeMap = new Map();
                let clusterId1 = 0;
                data.edges.forEach(edge => {
                    // edge.delete("label");
                    // if (edge.label && clusterEdgeMap.get(edge.label) === undefined) {
                    //     clusterEdgeMap.set(edge.label, clusterId1);
                    //     clusterId1++;
                    // }
                    edge.legendType=edge.label;
                    // const cid = clusterEdgeMap.get(edge.label);
                    // edge.style = {
                    //     stroke: colorSets[cid].mainStroke,
                    // };
                    // edge.labelCfg={
                    //     autoRotate: true,
                    //     style: {
                    //         lineWidth: 4,
                    //         fill: colorSets[cid].mainStroke, //colorSets[i].mainStroke, //'#1890ff',  //文字颜色
                    //         fontSize: 14,
                    //         background: {
                    //             fill: colorSets[cid].mainFill, //colorSets[i].mainFill
                    //             stroke: colorSets[cid].mainStroke,
                    //             padding: [2, 2, 2, 2],
                    //             radius: 2,
                    //         },
                    //     },
                    // };
                })

                // data.nodes.forEach((node,i) => {
                //     node.legendType=node.label;
                //     if(node.label==="Domain"){
                //         node.style = {
                //             fill: colorSets[0].mainFill, //colorSets[i].mainFill
                //             stroke: colorSets[0].mainStroke,
                //             // fill:'#61DDAA',
                //         }; 
                //         node.img="https://gw.alipayobjects.com/os/s/prod/antv/assets/image/logo-with-text-73b8a.svg";
                //     }else if(node.label==="Ip"){
                //         node.style = {
                //             fill: colorSets[1].mainFill,
                //             stroke: colorSets[1].mainStroke,
                //             // fill:'#9661BC',
                //         };
                //     }else if(node.label==="Company"){
                //         node.style = {
                //             fill: colorSets[2].mainFill,
                //             stroke: colorSets[2].mainStroke,
                //             // fill:'#F6BD16',
                //         };
                //     }else if(node.label==="Person"){
                //         node.style = {
                //             fill: colorSets[3].mainFill,
                //             stroke: colorSets[3].mainStroke,
                //             // fill:'#F6BD16',
                //         };
                //     }
                // }
                // );
                // data.edges.forEach((edge,i)=>{
                //     edge.legendType=edge.label;
                //     edge.labelCfg={
                //         autoRotate: true,
                //         style: {
                //             lineWidth: 4,
                //             fill:'#1890ff', //colorSets[i].mainStroke, //'#1890ff',  //文字颜色
                //             fontSize: 14,
                //             background: {
                //                 fill: colorSets[0].mainFill, //colorSets[i].mainFill
                //                 stroke: colorSets[0].mainStroke,
                //                 // fill: '#78D3F8',
                //                 // stroke: '#78D3F8',
                //                 padding: [2, 2, 2, 2],
                //                 radius: 2,
                //             },
                //         },
                //     }
                    
                    
                // })
                const nodeLegendSize = 15;
                const typeConfigs = {
                    'Domain': {
                        type: 'circle',
                        // size: 20,
                        r:nodeLegendSize, //图例节点的大小
                        style: {
                            fill: '#61DDAA',
                        }
                    },
                    'Ip': {
                        type: 'circle',
                        // size: 20,
                        r:nodeLegendSize,
                        style: {
                            fill: '#9661BC'
                        }
                    },
                    'Company': {
                        type: 'circle',
                        // size: 20,
                        r:nodeLegendSize,
                        style: {
                        fill: '#F6BD16'
                        }
                    },
                    'Cert': {
                        type: 'circle',
                        // size: 20,
                        r:nodeLegendSize,
                        style: {
                            fill: '#008685',
                        }
                    },
                    'Person':{
                        type: 'circle',
                        // size: 20,
                        r:nodeLegendSize,
                        style: {
                            fill: '#7262FD',
                        }
                    },
                    //
                    'HAS_IP': {
                        type: 'line',
                        style: {
                        width: 20,
                        stroke: '#F6BD16',
                        }
                    },
                    'HAS_CERT': {
                        type: 'line',
                        style: {
                        width: 20,
                        stroke: '#78D3F8',
                        }
                    },
                    'FOUNDED_BY': {
                        type: 'line',
                        style: {
                        width: 20,
                        stroke: '#008685',
                        }
                    },
                    'IS_SUB':{
                        type: 'line',
                        style: {
                        width: 20,
                        stroke: '#008685',
                        }
                    },
                    'WORKS_FOR':{
                        type: 'line',
                        style: {
                        width: 20,
                        stroke: '#008685',
                        }
                    }
                }

                //图标
                data.nodes.forEach(node => {
                    if (!node.legendType) return;
                    node = Object.assign(node, {...typeConfigs[node.legendType]});
                })
                data.edges.forEach(edge => {
                    if (!edge.legendType) return;
                    const config = typeConfigs[edge.legendType];
                    edge = Object.assign(edge, {...config});
                })

                const legendData = {
                    nodes: [{
                        id: 'Domain',
                        label: 'Domain',
                        order: 0,
                        ...typeConfigs['Domain']
                    }, {
                        id: 'Ip',
                        label: 'Ip',
                        order: 1,
                        ...typeConfigs['Ip']
                    }, {
                        id: 'Company',
                        label: 'Company',
                        order: 2,
                        ...typeConfigs['Company']
                    },{
                        id: 'Cert',
                        label: 'Cert',
                        order: 3,
                        ...typeConfigs['Cert']
                    },{
                        id: 'Person',
                        label: 'Person',
                        order: 4,
                        ...typeConfigs['Person']
                    },
                    ],
                    edges: [{
                        id: 'HAS_IP',
                        label: 'HAS_IP',
                        order: 2,
                        ...typeConfigs['HAS_IP']
                    }, {
                        id: 'HAS_CERT',
                        label: 'HAS_CERT',
                        ...typeConfigs['HAS_CERT']
                    }, {
                        id: 'FOUNDED_BY',
                        label: 'FOUNDED_BY',
                        ...typeConfigs['FOUNDED_BY']
                    },{
                        id: 'IS_SUB',
                        label: 'IS_SUB',
                        ...typeConfigs['IS_SUB']
                    },
                    {
                        id: 'WORKS_FOR',
                        label: 'WORKS_FOR',
                        ...typeConfigs['WORKS_FOR']
                    }
                ]
                
                }
                const legend = new G6.Legend({
                    data: legendData,
                    align: 'center',
                    layout: 'vertical', // vertical  图标水平或竖直  horizontal
                    position: 'bottom-left',  //图标的位置
                    vertiSep: 10, //12竖直间距
                    horiSep: 20, //图例间的水平间距
                    offsetX: 10, //图例区域离 position 对应的默认位置的 x 方向的偏移量，可被用于图例位置的微调
                    offsetY: -10,
                    padding: [12, 4, 8, 16], //图例区域内部内容到边框的距离，四位数组分别代表上、右、下、左边距
                    containerStyle: {
                        fill: '#ccc',
                        lineWidth: 1
                    },
                    title: '',
                    titleConfig: {
                        position: 'center',
                        offsetX: 0,
                        offsetY: 12,
                    },
                    filter: {
                        enable: true,
                        trigger: 'mouseenter',
                        graphActiveState: 'activeByLegend',
                        graphInactiveState: 'inactiveByLegend',
                        filterFunctions: {
                            'Domain': (d) => {
                                if (d.legendType === 'Domain') return true;
                                return false
                            },
                            'Ip': (d) => {
                                if (d.legendType === 'Ip') return true;
                                return false
                            },
                            'Company': (d) => {
                                if (d.legendType === 'Company') return true;
                                return false
                            },
                            'Cert': (d) => {
                                if (d.legendType === 'Cert') return true;
                                return false
                            },
                            'Person': (d) => {
                                if (d.legendType === 'Person') return true;
                                return false
                            },
                            //edge
                            'HAS_IP': (d) => {
                                if (d.legendType === 'HAS_IP') return true;
                                return false
                            },
                            'HAS_CERT': (d) => {
                                if (d.legendType === 'HAS_CERT') return true;
                                return false
                            },
                            'FOUNDED_BY': (d) => {
                                if (d.legendType === 'FOUNDED_BY') return true;
                                return false
                            },
                            'IS_SUB': (d) => {
                                if (d.legendType === 'IS_SUB') return true;
                                return false
                            },
                            'WORKS_FOR': (d) => {
                                if (d.legendType === 'WORKS_FOR') return true;
                                return false
                            },
                        }
                    }
                });

                //tooltip 悬浮提示框
                const tooltip = new G6.Tooltip({
                    offsetX: 10,
                    offsetY: 10,
                    // the types of items that allow the tooltip show up
                    // 允许出现 tooltip 的 item 类型
                    itemTypes: ['node', 'edge'],
                    // custom the tooltip's content
                    // 自定义 tooltip 内容
                    getContent: (e) => {
                        const outDiv = document.createElement('div');
                        outDiv.style.width = 'fit-content';
                        //outDiv.style.padding = '0px 0px 20px 0px';
                        // <ul>
                        //     <li>节点类型:${e.item.getType()}</li>
                        // </ul>
                        if(e.item.getType()=="node"){
                            outDiv.innerHTML = `
                            <h4>节点信息</h4>
                            <ul>
                                <li>节点类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                            </ul>
                            <ul>
                                <li>节点名称: ${e.item.getModel().properties["name"] || e.item.getModel().id}</li>
                            </ul>
                            <ul>
                                <li>PageRank: ${result[e.item.getModel().id]}</li>
                            </ul>
                        `;
                        }
                        else if(e.item.getType()=="edge"){
                            outDiv.innerHTML = `
                                <h4>边信息</h4>
                                <ul>
                                    
                                    <li>边类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                                </ul>
                            `;
                        }
                        // outDiv.innerHTML = `
                        // <h4>节点信息</h4>
                        // <ul>
                        //     <li>节点类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                        // </ul>
                        // <ul>
                        //     <li>节点名称: ${e.item.getModel().properties["name"] || e.item.getModel().id}</li>
                        // </ul>
                        // <ul>
                        //     <li>PageRank: ${result[e.item.getModel().id]}</li>
                        // </ul>
                        // `;
                        return outDiv;
                    },
                });

                const graph = new G6.Graph({
                    container: 'all-container',
                    width,   //: 800,
                    height,//: 500,

                    // fitView:true, 别开最好
                    //TODO:注意 fitCenter和layout中的center只选择一个
                    // fitCenter: true,
                    modes: {
                        default: ['drag-canvas', 'activate-relations', 'zoom-canvas'],
                    },
                    layout: {
                        type: 'force',
                        linkDistance: 150, //边的长度 180
                        preventOverlap: true,
                        nodeStrength: -170,  //节点的引力，负数代表斥力
                        center: [ 500, 200 ],     // 可选，默认为图的中心
                        // center: [width / 2, height / 2],
                    },
                    defaultNode: {
                        size: 20,
                        /* node type */
                        type: 'circle',
                        /* node size */
                        // size: [60],
                        /* style for the keyShape */
                        style: {
                        // fill: '#9EC9FF',
                        // stroke: '#5B8FF9',
                        lineWidth: 2,
                        },
                        labelCfg: {
                        /* label's position, options: center, top, bottom, left, right */
                            position: 'bottom',
                            /* label's offset to the keyShape, 4 by default */
                            //   offset: 12,
                            /* label's style */
                            //   style: {
                            //     fontSize: 20,
                            //     fill: '#ccc',
                            //     fontWeight: 500
                            //   }
                        },
                        icon: {
                            /* whether show the icon, false by default */
                            show: true,
                            /* icon's img address, string type */
                            // TODO:《在vue中使用阿里巴巴svg图标》 https://blog.csdn.net/weixin_44867717/article/details/108698021
                            img: 'https://gw.alipayobjects.com/zos/basement_prod/012bcf4f-423b-4922-8c24-32a89f8c41ce.svg',
                            
                            /* icon's size, 20 * 20 by default: */
                            //   width: 40,
                            //   height: 40
                        },
                    },
                    defaultEdge: {
                        style:{  //TODO:可以修改箭头的样式  https://g6.antv.antgroup.com/manual/middle/elements/edges/arrow
                            endArrow:true
                        }
                    },
                    nodeStateStyles: {
                        activeByLegend: {
                        lineWidth: 10,
                        strokeOpacity: 0.5
                        },
                        inactiveByLegend: {
                        opacity: 0.5
                        }
                    },
                    edgeStateStyles: {
                        activeByLegend: {
                        lineWidth: 3
                        },
                        inactiveByLegend: {
                        opacity: 0.5
                        }
                    },
                    animate: true,
                    plugins: [legend,tooltip],
                });
                graph.data({
                    nodes: data.nodes,
                    edges: data.edges.map(function (edge, i) {
                        edge.id = 'edge' + i;
                        return Object.assign({}, edge);
                    }),
                    // edges: this.graphData.edges
                });
                graph.render();

                graph.on('node:dragstart', function (e) {
                graph.layout();
                refreshDragedNodePosition(e);
                });
                graph.on('node:drag', function (e) {
                const forceLayout = graph.get('layoutController').layoutMethods[0];
                forceLayout.execute();
                refreshDragedNodePosition(e);
                });
                graph.on('node:dragend', function (e) {
                e.item.get('model').fx = null;
                e.item.get('model').fy = null;
                });

                if (typeof window !== 'undefined')
                window.onresize = () => {
                    if (!graph || graph.get('destroyed')) return;
                    if (!container || !container.scrollWidth || !container.scrollHeight) return;
                    graph.changeSize(container.scrollWidth, container.scrollHeight);
                };
            });

            function refreshDragedNodePosition(e) {
            const model = e.item.get('model');
            model.fx = e.x;
            model.fy = e.y;
            }
        }
    },
    mounted() {
        this.show()
    },
}
</script>

<style scoped>
    .graph-container1{
        display:flex;
        scrollWidth:400px; 
        scrollHeight:600px;
    }
</style>