<template>
    <div class="page-container" >
        <!-- <el-row gutter="20" style="">
            <el-col :span="10">
                <NewSiteInfo :siteInfo="siteInfo"/>
                TODO:卡片的背景颜色background-color: #343A40;
                <el-card style="position:relative;"> 
                    <div style="margin-bottom:10px">
                        <el-button v-if="this.siteInfo.isMalicious==true" type="danger" round style="font-weight:bold">{{siteInfo.domain}}</el-button>
                        <el-button v-if="this.siteInfo.isMalicious==false" type="success" round style="font-weight:bold">{{siteInfo.domain}}</el-button>
                        <el-button v-if="this.siteInfo.isMalicious==true" type='danger' round style="font-weight:bold">恶意</el-button>
                        <el-button v-if="this.siteInfo.isMalicious==false" type='success' round style="font-weight:bold">良性</el-button>
                    </div> 
                    <SiteInfoCard :siteInfo="siteInfo"/>
                </el-card> 
            </el-col>
        </el-row> -->
        <el-row>
            <el-col :span="7"> 
                <NewSiteInfo :siteInfo="siteInfo"/>
            </el-col>

            <el-col :span="17">
                <el-card style="height: fit-content;height:500px">
                    <!-- <div style="text-align: center!important;">
                        <svg t="1681217131219" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12719" width="60" height="60"><path d="M0 0m512 0l0 0q512 0 512 512l0 0q0 512-512 512l0 0q-512 0-512-512l0 0q0-512 512-512Z" fill="#82529d" p-id="12720" data-spm-anchor-id="a313x.7781069.0.i12" class=""></path><path d="M534.4512 244.7616l-239.9488 102.5664a19.2 19.2 0 0 0-11.648 17.664V761.6a19.2 19.2 0 0 0 19.2 19.2h239.936a19.2 19.2 0 0 0 19.2-19.2v-499.2a19.2 19.2 0 0 0-26.752-17.664z m-11.6608 46.7328V742.4H321.2544V377.6512l201.536-86.1568zM614.2464 394.5984l104.96 34.1888a19.2 19.2 0 0 1 13.184 16.4992l0.0768 1.7664V761.6h-38.4V460.9792l-91.7248-29.8624 11.904-36.5184z" fill="#ffffff" p-id="12721" data-spm-anchor-id="a313x.7781069.0.i13" class="selected"></path><path d="M778.1888 742.4v38.4H245.8112v-38.4zM488.5632 430.1056v40.3072l-134.4 34.2528v-40.32l134.4-34.24z m-19.2128 24.704l-96 24.4608v0.6784l96-24.4608v-0.6784zM488.5632 537.472v40.32l-134.4 34.24v-40.3072l134.4-34.2528z m-19.2128 24.704l-96 24.4608v0.6784l96-24.4608v-0.6784z" fill="#FFFFFF" p-id="12722"></path></svg>
                        <div style="font-size: 18px;margin-top: 10px;margin-bottom: 18px;">
                            <button type="button" class="el-button el-button--danger el-button--medium is-round" style="font-weight: bold;background-color:purple;border-color:purple">
                                <span>学而思公司</span>
                            </button>
                        </div>
                    </div>  -->
                    <CompanyInfoCard :companyInfo="companyInfo" :personInfo="personInfo"/>
                </el-card>

            </el-col>
        </el-row>

        <el-row gutter="10">
            <el-col :span="12"> 
                <el-card style="height:350px">
                    <div class="card-title" >网站截图取证</div>
                    <div class="block" style="height:275px">
                        <el-scrollbar style="height: 100%;" class="scrollbar-for"  wrap-style="overflow-x:hidden;">
                            <el-image :src="src" style="width:100%" fit="fill">
                                <div slot="placeholder" class="image-slot">
                                  加载中<span class="dot">...</span>
                                </div>
                              </el-image>
                        </el-scrollbar>
                    </div>
                </el-card> 
            </el-col>
            <el-col :span="12"> 
                    <el-card  style="height:350px">
                        <div class="card-title" >网站相似度排名</div>
                        <SimilarSiteBar/>
                    </el-card>
            </el-col>
        </el-row>


        <el-row>
            <el-card>
                <div class="card-title" >网站关联图谱</div>
                <div class="graph-menu" style="margin-botttom:5px">
                    <!-- <el-button type="primary" plain>一度关系</el-button> -->
                    <el-button @click="fetchData(2)" type="primary" plain>二度关系</el-button>
                    <el-button @click="fetchData(3)" type="primary" plain>三度关系</el-button> 
                    <!-- <el-button @click="" type="primary" plain>全部关联</el-button>  -->
                    <!-- <el-switch v-model="value1" active-text="显示节点名称" inactive-text=" "> </el-switch> -->
                </div>

                <el-row>
                    <el-col :span="16">
                        <div style="border:1px solid #ddd;border-radius:10px">
                            <div id="container" class="graph-container"></div>
                        </div>
                    </el-col>
                    
                    <el-col :span="8">
                        <!-- TODO:1、增加统计卡片：关联的网站、域名的数量；2、也可以增加右键展开节点的功能 -->
                        <div class="graph-count" style="margin-left:50px">
                            <GraphCountCard header="关联网站" :countNumber="labelCounts.Website"/>
                            <GraphCountCard header="关联IP" :countNumber="labelCounts.Ip"/>
                            <GraphCountCard header="关联公司" :countNumber="labelCounts.Company"/>
                            <GraphCountCard header="关联人员" :countNumber="labelCounts.Person"/>
                        </div>
                    </el-col>
                </el-row>
            </el-card>
        </el-row>

        <el-row gutter=10>
            <el-col :span="12" >
                <el-card class="sub-chart">
                    <div class="card-title" >PageRank节点重要性排名</div>
                    <div id="pageRankColumn" style="width:520px;height:300px"></div>
                    <!-- width:520px;height:300px -->
                </el-card>
            </el-col>
            <!-- TODO:根据pagerank的值设置节点桑基图的value -->
            <el-col :span="12" >
                <el-card class="sub-chart">
                    <div class="card-title" >节点桑基图</div>
                    <div id="sanky" style="width:520px;height:300px"></div>
                </el-card>
            </el-col>
           
        </el-row>
        <!-- <div id="chord-container" style="width:520px;height:300px"></div> -->
        
        <!-- <h4>
            知识图谱：
            展示个数：相关ip、相关证书、相关网站、相关公司、相关持有人
            1、一个网站直接相关联的其他实体（一度信息）：公司、证书、持有人等
            2、一个网站相关联的其他网站（可以放2度？）
        </h4>
        <el-button @click="drawer = true" type="primary" style="margin-left: 16px;">
            点我打开
        </el-button>
        <el-drawer
            title="我是标题"
            style="height:50%;margin-top:60px"
            :visible.sync="drawer"
            :direction="direction"
            :before-close="handleClose">
            <span>我来啦!</span>
            
        </el-drawer> -->
    </div>
    
</template>

<script>

import G6 from '@antv/g6';
import insertCss from 'insert-css';
import { Column } from '@antv/g2plot';
import { pageRank } from "@antv/algorithm";
import { Sankey } from '@antv/g2plot';
import CompanyInfoCard from "./component/CompanyInfoCard"
import SiteInfoCard from "./component/SiteInfoCard"
import SimilarSiteBar from "./component/SimilarSiteBar"
import NewSiteInfo from "./component/NewSiteInfo"
import GraphCountCard from './component/GraphCountCard.vue';
import { Chord } from '@antv/g2plot';
import { dataTool } from 'echarts/lib/echarts';

export default {
    data() {
        return {
            siteId: '',
            siteInfo: [],
            companyInfo:[],
            personInfo:[],
            dialogTableVisible: false,
            dialogFormVisible: false,
            formLabelWidth: '120px',
            form: {
                name: '',
                region: '',
                date1: '',
                date2: '',
                delivery: false,
                type: [],
                resource: '',
                desc: ''
            },
            tableData: [{
                date: '2016-05-02',
                name: '王小虎',
                address: '上海市普陀区金沙江路 1518 弄'
                }, {
                date: '2016-05-04',
                name: '王小虎',
                address: '上海市普陀区金沙江路 1517 弄'
                }, {
                date: '2016-05-01',
                name: '王小虎',
                address: '上海市普陀区金沙江路 1519 弄'
                }, {
                date: '2016-05-03',
                name: '王小虎',
                address: '上海市普陀区金沙江路 1516 弄'
            }],

            drawer: false,
            direction: 'rtl',

            value1:true, //开关

            graph:'',
            src:"",
            labelCounts:[],
            // src: 'http://47.99.124.12:8050/render.jpeg?url=http://www.piaodown.com/app/1044707.html',
        };
    },
    components:{
        CompanyInfoCard,
        SiteInfoCard,
        SimilarSiteBar,
        NewSiteInfo,
        GraphCountCard
    },
    
    created(){
        this.siteId= this.$route.query.id;
        this.getDetail();
        
    },
    methods:{
        formatter(row, column) {
            return row.address;
        },
        handleClose(done) {
        this.$confirm('确认关闭？')
          .then(_ => {
            done();
          })
          .catch(_ => {});
        },
        getScreenShot(url){
            this.src = "http://47.99.124.12:8050/render.jpeg?url="+url;
        },
        //由getDetai调用show graph
        getDetail(){
            //监听url的id属性，将id传给这里查询
            // console.log(this.$route.$query.id)
            this.axios({
                url:"api/sites/id/"+this.siteId,
                method: 'get',
            }).then(res=>{
                console.log("res data data")
                console.log(res.data.data);
                this.siteInfo = res.data.data;
                this.getScreenShot(this.siteInfo.url)
                this.showGraph2(); //TODO:调用graph
                //获取公司信息
                this.axios({
                    url:"api/company/id/"+this.siteInfo.companyId,
                    method:'get'
                }).then(res=>{
                    this.companyInfo = res.data.data
                    console.log(this.companyInfo)
                    //获取人员信息
                    if(this.companyInfo.personId!=null){
                        this.axios({
                            url:"api/person/id/"+this.companyInfo.personId,
                            method:'get'
                        }).then(res=>{
                            this.personInfo = res.data.data
                            console.log(this.personInfo)
                        })
                    }
                })
            })


        },
        preparePageRankData(rankResult){
            const data = []
            for(var key in rankResult){
                var nodeName;
                var nodeType;
                this.graph.nodes.forEach(node => {
                    if(node["id"]==key){
                        nodeName = node.properties["name"];
                        nodeType = node.label;
                    }
                });
                data.push({
                    nodeId:key,
                    nodeName: nodeName,
                    pageRankValue: rankResult[key],
                    nodeType: nodeType,
                })
            } 
            console.log(data.sort((a, b) => b.pageRankValue - a.pageRankValue))
            return data.sort((a, b) => b.pageRankValue - a.pageRankValue); //按照高低排序
        },
        //TODO: 修改为只显示前6个数据
        showPageRankColumn(rankResult){
            const data = this.preparePageRankData(rankResult).slice(0,10)
            const paletteSemanticRed = '#F4664A';
            const brandColor = '#5B8FF9';
            const columnPlot = new Column('pageRankColumn', { //dom节点的id
                data, //数据
                xField: 'nodeName',
                yField: 'pageRankValue',
                seriesField: '',
                color: ({ nodeName }) => {
                    // if (nodeName === 'sub50') {
                    //     return paletteSemanticRed;
                    // }
                    return brandColor;
                },
                label: {
                    // position: 'middle', // 'top', 'bottom', 'middle',
                    // // 配置样式
                    // style: {
                    //     fill: '#6FFFFF',
                    //     opacity: 0.6,
                    // },
                    content: (originData) => {
                    const val = parseFloat(originData.value);
                    if (val < 0.05) {
                        return (val * 100).toFixed(1) + '%';
                    }
                    },
                    offset: 10,
                },
                legend: false,
                xAxis: {
                    label: {
                    autoHide: true,
                    autoRotate: true,
                    // rotate:30,
                    },
                },
                columnStyle: { //圆角
                    radius: [5, 5, 0, 0],
                },
            });
            this.pageRankColum = columnPlot;
            columnPlot.render();
        },
        //桑吉图渲染 注意边需要有value
        prepareSankeyData(originEdges){
            const edges = []; //新建一个数组，如果直接对原数组赋值的话，会直接改变原数组，导致图无法正确显示。
            for(var key in originEdges){
                edges.push({});
                edges[key]["value"]=1;
                //将id替换为name
                this.graph.nodes.forEach(node => {
                    if(node["id"]==originEdges[key]["source"]){
                        edges[key]["source"] = node.properties["name"];
                    }
                    if(node["id"]==originEdges[key]["target"]){
                        edges[key]["target"] = node.properties["name"];
                    }
                });
            }
            return edges;
        },
        showSanky(originEdges){   
            const edges = this.prepareSankeyData(originEdges);
            // this.showChord(originEdges)
            const sankey = new Sankey('sanky', {
                data: edges,
                sourceField: 'source',
                targetField: 'target',
                weightField: 'value',
                nodeWidthRatio: 0.008,
                nodePaddingRatio: 0.03,
            });
            this.sankey = sankey;
            sankey.render();
        },
        showChord(originEdges){
            const edges = []; //新建一个数组，如果直接对原数组赋值的话，会直接改变原数组，导致图无法正确显示。
            for(var key in originEdges){
                edges.push({});
                edges[key]["value"]=1;
                //将id替换为name
                this.graph.nodes.forEach(node => {
                    if(node["id"]==originEdges[key]["source"]){
                        edges[key]["source"] = node.properties["name"];
                    }
                    if(node["id"]==originEdges[key]["target"]){
                        edges[key]["target"] = node.properties["name"];
                    }
                });
            }
            const DATA = [
            { source: '北京', target: '天津', value: 30 },
            { source: '北京', target: '上海', value: 80 },
            { source: '北京', target: '河北', value: 46 },
            { source: '北京', target: '辽宁', value: 49 },
            { source: '北京', target: '黑龙江', value: 69 },
            { source: '北京', target: '吉林', value: 19 },
            { source: '天津', target: '河北', value: 62 },
            { source: '天津', target: '辽宁', value: 82 },
            { source: '天津', target: '上海', value: 16 },
            { source: '上海', target: '黑龙江', value: 16 },
            { source: '河北', target: '黑龙江', value: 76 },
            { source: '河北', target: '内蒙古', value: 24 },
            { source: '内蒙古', target: '北京', value: 32 },
            ];

            const chord = new Chord('chord-container', {
                data: edges,
                sourceField: 'source',
                targetField: 'target',
                weightField: 'value',
            });

            chord.render();

        },
        async fetchData(depth) {
            // 发起异步请求获取新数据
            const response = await fetch('api/graph/domain?'+"dname="+this.siteInfo.domain+"&depth="+depth);
            const newData = await response.json();
            this.graph = newData; //新增，不知道对不对
            this.countGraphType() //计算数量
            console.log("newcount",this.labelCounts)
            //PageRank
            let result = pageRank(newData); 
            const data = this.preparePageRankData(result)
            this.pageRankColum.changeData(data);
            //桑基图
            const edges = this.prepareSankeyData(newData.edges);
            this.sankey.changeData(edges)
            console.log("await",newData);

            // 更新数据并重新渲染画布
            const subjectColors = [
                    '#5F95FF', // blue
                    '#61DDAA',
                    '#65789B',
                    '#F6BD16',
                    '#7262FD',
                    '#78D3F8',
                    '#9661BC',
                    '#F6903D',
                    '#008685',
                    '#F08BB4',
            ];
            const backColor = '#fff';//
            const theme = 'default';
            const disableColor = '#777';
            const colorSets = G6.Util.getColorSetsBySubjectColors(
                subjectColors,
                backColor,
                theme,
                disableColor,
            );
            //给新节点上色
            const clusterNode = ["Website","Company","Person","Ip","Redirect"];
            const clusterEdge = ["BELONGS_TO","DOWNLOAD_FROM","HAS_IP","HAS_COMPANY"];
            newData.nodes.forEach(function (node) {
                const cid = clusterNode.indexOf(node.label);
                node.legendType=node.label;
                if (!node.style) {
                    node.style = {};
                }
                node.style.fill = colorSets[cid].mainStroke; //subjectColors
                node.style.stroke = colorSets[cid].mainStroke; //strokes[cid % strokes.length];
            });
            newData.edges.forEach(edge => {
                const cid = clusterEdge.indexOf(edge.label);
                edge.legendType=edge.label;
                edge.style = {
                    stroke: colorSets[cid].mainStroke  //colorSets[cid].mainStroke,
                };
                edge.color = colorSets[cid].mainStroke;  //设置边的颜色
                edge.labelCfg={
                    autoRotate: true,
                    style: {
                        lineWidth: 4,
                        fill: colorSets[cid].mainStroke, //colorSets[i].mainStroke, //'#1890ff',  //文字颜色
                        fontSize: 14,
                        background: {
                            fill: colorSets[cid].mainFill, // colorSets[cid].mainFill 标签背景颜色
                            stroke: colorSets[cid].mainStroke,  //colorSets[cid].mainStroke 标签边框
                            padding: [2, 2, 2, 2],
                            radius: 2,
                        },
                    },
                };
            })
            // 更新数据并重新渲染画布
            this.graphCanvas.changeData(newData);
        },
        showGraph2(depth=2){ //传入深度，默认为2度关系
            const containerId = "container"
            const container = document.getElementById(containerId);
            const width = container.scrollWidth ||300;
            const height = container.scrollHeight || 420; //TODO:原本为450，这里修改画布的高度
            insertCss(`
            .g6-component-tooltip {
                background-color: rgba(255, 255, 255, 0.8);
                padding: 0px 10px 24px 10px;
                box-shadow: rgb(174, 174, 174) 0px 0px 10px;
            }
            .g6-component-contextmenu {
                position: absolute;
                z-index: 2;
                list-style-type: none;
                background-color: #363b40; 
                border-radius: 6px;
                font-size: 14px;
                color: hsla(0,0%,100%,.85);
                width: fit-content;
                transition: opacity .2s;
                text-align: center;
                padding: 0px 20px 0px 20px;
                    box-shadow: 0 5px 18px 0 rgba(0, 0, 0, 0.6);
                    border: 0px;
            }
            .g6-component-contextmenu ul {
                    padding-left: 0px;
                    margin: 0;
            }
            .g6-component-contextmenu li {
                cursor: pointer;
                list-style-type: none;
                list-style: none;
                margin-left: 0;
                line-height: 38px;
            }
            .g6-component-contextmenu li:hover {
                color: #aaaaaa;
                }
            `);
            ////https://gw.alipayobjects.com/os/antvdemo/assets/data/relations.json
            ///TODO:现在数据库还没建立起来，所以无法通过域名名称查到对应的图谱。
            //api/graph/domain?dname=example.com1&depth=2
            //真正的请求'api/graph/domain?'+"dname="+this.siteInfo.domain+"&depth="+depth
            //测试请求api/graph/test 最初的测试api，数据写死    http://localhost:8888/graph/test
            fetch('api/graph/domain?'+"dname="+this.siteInfo.domain+"&depth="+depth) 
            .then((res) => res.json())
            .then((data) => {
                //TODO:调用图谱统计方法
                this.graph = data;
                console.log(this.graph)
                this.countGraphType()

                const subjectColors = [
                    '#5F95FF', // blue
                    '#61DDAA',
                    '#65789B',
                    '#F6BD16',
                    '#7262FD',
                    '#78D3F8',
                    '#9661BC',
                    '#F6903D',
                    '#008685',
                    '#F08BB4',
                ];
                const backColor = '#fff';//
                const theme = 'default';
                const disableColor = '#777';
                const colorSets = G6.Util.getColorSetsBySubjectColors(
                    subjectColors,
                    backColor,
                    theme,
                    disableColor,
                );

                //1、PageRank算法结果展示
                let result = pageRank(data); //return Object[id: pagerank] 
                this.showPageRankColumn(result);
                console.log(result);
                //2、桑基图
                this.showSanky(data.edges);

                //3、分类
                const clusterNode = ["Website","Company","Person","Ip","Redirect"];
                const clusterEdge = ["BELONGS_TO","DOWNLOAD_FROM","HAS_IP","HAS_COMPANY"];
                // const clusterNode = ["Domain","Company","Person","Ip","Cert"];
                data.nodes.forEach(function (node) {
                    const cid = clusterNode.indexOf(node.label);
                    node.legendType=node.label;
                    if (!node.style) {
                        node.style = {};
                    }
                    node.style.fill = colorSets[cid].mainStroke; //subjectColors
                    node.style.stroke = colorSets[cid].mainStroke; //strokes[cid % strokes.length];
                });
                
                // const clusterEdge = ["IS_SUB","FOUNDED_BY","HAS_IP","WORKS_FOR","HAS_CERT"];
                data.edges.forEach(edge => {
                    const cid = clusterEdge.indexOf(edge.label);
                    edge.legendType=edge.label;
                    edge.style = {
                        stroke: colorSets[cid].mainStroke  //colorSets[cid].mainStroke,
                    };
                    edge.color = colorSets[cid].mainStroke;  //设置边的颜色
                    edge.labelCfg={
                        autoRotate: true,
                        style: {
                            lineWidth: 4,
                            fill: colorSets[cid].mainStroke, //colorSets[i].mainStroke, //'#1890ff',  //文字颜色
                            fontSize: 13, //标签文字大小：原来14px
                            background: {
                                fill: colorSets[cid].mainFill, // colorSets[cid].mainFill 标签背景颜色
                                stroke: colorSets[cid].mainStroke,  //colorSets[cid].mainStroke 标签边框
                                padding: [2, 2, 2, 2],
                                radius: 2,
                            },
                        },
                    };
                })

                var legendConfig = {}; 
                const nodeLegendSize = 15;
                var legendData = {}
                legendData.nodes = [];
                legendData.edges = [];
                var filterFunctions = {};
                clusterNode.forEach(element => {
                    const cid = clusterNode.indexOf(element);
                    var nodeLegendConfig = {};
                    nodeLegendConfig["r"]=nodeLegendSize; //图例节点的大小
                    nodeLegendConfig["style"] = {
                        "fill":colorSets[cid].mainStroke,
                        "stroke":colorSets[cid].mainStroke //设置这个，不然node的边框会变成蓝色
                    };
                    legendConfig[element]=nodeLegendConfig;

                    legendData.nodes.push({
                        id:element,
                        label:element,
                        ...legendConfig[element]
                    })
                    filterFunctions[element] = (d)=>{if (d.legendType === element) return true;return false}
                });

                clusterEdge.forEach(element=>{
                    const cid = clusterEdge.indexOf(element);
                    var edgeLegendConfig = {};
                    edgeLegendConfig["type"]="line"; //图例节点的大小
                    edgeLegendConfig["style"]={"stroke":colorSets[cid].mainStroke,"width":20};
                    legendConfig[element]=edgeLegendConfig;

                    legendData.edges.push({
                        id: element,
                        label: element,
                        ...legendConfig[element]
                    })
                    filterFunctions[element] = (d)=>{if (d.legendType === element) return true;return false}
                })
                console.log(filterFunctions)
                const legend = new G6.Legend({
                    data: legendData,
                    align: 'center',
                    layout: 'vertical', // vertical  图标水平或竖直  horizontal
                    position: 'bottom-left',  //TODO: 图标的位置原本为bottom-left
                    vertiSep: 10, //12竖直间距
                    horiSep: 20, //图例间的水平间距
                    offsetX: 10, //图例区域离 position 对应的默认位置的 x 方向的偏移量，可被用于图例位置的微调
                    offsetY: -10,
                    padding: [12, 4, 8, 16], //图例区域内部内容到边框的距离，四位数组分别代表上、右、下、左边距
                    containerStyle: {
                        fill: '#ccc',
                        lineWidth: 1
                    },
                    title: '',
                    titleConfig: {
                        position: 'center',
                        offsetX: 0,
                        offsetY: 12,
                    },
                    filter: {
                        enable: true,
                        trigger: 'mouseenter',
                        graphActiveState: 'activeByLegend',
                        graphInactiveState: 'inactiveByLegend',
                        filterFunctions: filterFunctions
                    }
                });

                //tooltip 悬浮提示框
                const tooltip = new G6.Tooltip({
                    offsetX: 10,
                    offsetY: 10,
                    // the types of items that allow the tooltip show up
                    // 允许出现 tooltip 的 item 类型
                    itemTypes: ['node', 'edge'],
                    // custom the tooltip's content
                    // 自定义 tooltip 内容
                    getContent: (e) => {
                        const outDiv = document.createElement('div');
                        outDiv.style.width = 'fit-content';
                        //outDiv.style.padding = '0px 0px 20px 0px';
                        // <ul>
                        //     <li>节点类型:${e.item.getType()}</li>
                        // </ul>
                        if(e.item.getType()=="node"){
                            outDiv.innerHTML = `
                            <h4>节点信息</h4>
                            <ul>
                                <li>节点类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                            </ul>
                            <ul>
                                <li>节点名称: ${e.item.getModel().properties["name"] || e.item.getModel().id}</li>
                            </ul>
                            <ul>
                                <li>PageRank: ${result[e.item.getModel().id]}</li>
                            </ul>
                        `;
                        }
                        else if(e.item.getType()=="edge"){
                            outDiv.innerHTML = `
                                <h4>边信息</h4>
                                <ul>
                                    
                                    <li>边类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                                </ul>
                            `;
                        }
                        // outDiv.innerHTML = `
                        // <h4>节点信息</h4>
                        // <ul>
                        //     <li>节点类型:<button style="font-weight: bold;"> ${e.item.getModel().label}</button></li>
                        // </ul>
                        // <ul>
                        //     <li>节点名称: ${e.item.getModel().properties["name"] || e.item.getModel().id}</li>
                        // </ul>
                        // <ul>
                        //     <li>PageRank: ${result[e.item.getModel().id]}</li>
                        // </ul>
                        // `;
                        return outDiv;
                    },
                });
                let hiddenItemIds = []; // 隐藏的元素 id 数组
                let expandArray = [];
                let collapseArray = [];
                let newAddArray = [];
                const hideItems = (graph) => {
                    hiddenItemIds.forEach((id) => {
                        graph.hideItem(id);
                    });
                };

                const showItems = (graph) => {
                    graph.getNodes().forEach((node) => {
                        if (!node.isVisible()) graph.showItem(node);
                    });
                    graph.getEdges().forEach((edge) => {
                        if (!edge.isVisible()) edge.showItem(edge);
                    });
                    hiddenItemIds = [];
                };

                const findNeighbors = (graph,model,depth=1) =>{
                    fetch("api/graph/domain?dname="+model.properties.name+"&depth="+depth)
                    .then((res) => res.json())
                    .then((data) => {
                        var newNodeCount = 0;
                        var newEdgeCount = 0;
                        data.nodes.forEach((node)=>{
                            if(!graph.findById(node.id)){
                                newNodeCount+=1;
                                newAddArray.push(node.id);
                                console.log("not find",node.id)
                                node.legendType=node.label;
                                if (!node.style) {
                                    node.style = {};
                                }
                                node.icon = {
                                    show:true,
                                    img:require("@/assets/nodes/"+node.label+".png"),
                                    // img:require("@/assets/nodes/Redirect.png"),
                                }
                                node.style.fill = "#fff";
                                node.style.stroke = "#fff";
                                graph.addItem('node',node );
                            }
                        })

                        data.edges.forEach((edge)=>{
                            edge.label=null;
                            const rs = graph.find("edge",(oedge)=>{
                                return oedge.get('model').source==edge.source&& oedge.get('model').target==edge.target;
                            })
                            console.log(rs)
                            if(!rs){
                                edge.id = 'edge' + edge.id;
                                graph.addItem('edge',edge );
                                newEdgeCount+=1;
                            }
                        })
                        if(newNodeCount==0){
                            this.noMoreInfo()
                        }else{
                            this.haveMoreInfo(newNodeCount,newEdgeCount)
                        }
                    })
                }
                    //菜单 
                const contextMenu = new G6.Menu({
                    shouldBegin(evt) {
                        if (evt.target && evt.target.isCanvas && evt.target.isCanvas()) return true;
                        if (evt.item) return true;
                        return false;
                    },
                    getContent(evt) {
                        const { item } = evt;
                        let header;
                        if (evt.target && evt.target.isCanvas && evt.target.isCanvas()) { //右键画布
                            return `<ul>
                            <li id='show'>显示全部隐藏节点</li>
                            <li id='collapseAll'>Collapse all Clusters</li>
                            </ul>`;
                        } 
                        else if (!item) return;
                        const itemType = item.getType();
                        const model = item.getModel();
                        if (itemType && model) {
                            if (itemType == 'node') { //右键节点
                                return `
                                    <ul>
                                        <li id='expand'>展开一度关联节点</li>
                                        <li id='expand2'>展开二度关联节点</li>
                                        <li id='hideNeighbor'>折叠关联节点</li>
                                        <li id='hide'>隐藏节点</li>
                                    </ul>`;
                            }
                        }
                    },
                    handleMenuClick: (target, item) => {
                        const model = item && item.getModel();
                        const liIdStrs = target.id.split('-');
                        let mixedGraphData;
                        switch (liIdStrs[0]) {
                        case 'hide':
                            graph.hideItem(item);
                            hiddenItemIds.push(model.id);
                            break;
                        case 'expand':
                            findNeighbors(graph,model)
                            break;
                        case 'expand2':
                            findNeighbors(graph,model,2)
                                break;
                        case 'collapse':
                            const aggregatedNode = aggregatedNodeMap[model.clusterId];
                            manipulatePosition = { x: aggregatedNode.x, y: aggregatedNode.y };
                            collapseArray.push(aggregatedNode);
                            for (let i = 0; i < expandArray.length; i++) {
                                if (expandArray[i].id === model.clusterId) {
                                    expandArray.splice(i, 1);
                                    break;
                                }
                            }
                            mixedGraphData = getMixedGraph(
                                clusteredData,
                                data,
                                nodeMap,
                                aggregatedNodeMap,
                                expandArray,
                                collapseArray,
                            );
                            break;
                        case 'collapseAll':
                            newAddArray.forEach(id=>{
                                graph.hideItem(id)
                            });
                            break;
                        case 'neighbor':
                            const expandNeighborSteps = parseInt(liIdStrs[1]);
                            mixedGraphData = getNeighborMixedGraph(
                                model,
                                expandNeighborSteps,
                                data,
                                clusteredData,
                                currentUnproccessedData,
                                nodeMap,
                                aggregatedNodeMap,
                                10,
                            );
                            break;
                        case 'hideNeighbor':
                            const node = graph.findById(model.id);
                            const neightborList = node.getNeighbors()
                            neightborList.forEach(element=>{
                                const id = element.getModel().id
                                graph.hideItem(id)
                                hiddenItemIds.push(id); //将邻居节点id加入隐藏数组
                            })
                            //隐藏节点本身
                            graph.hideItem(item);
                            hiddenItemIds.push(model.id);
                            break;
                        case 'show':
                            showItems(graph);
                            break;
                        default:
                            break;
                        }
                        if (mixedGraphData) {
                            cachePositions = cacheNodePositions(graph.getNodes());
                            currentUnproccessedData = mixedGraphData;
                            handleRefreshGraph(
                                graph,
                                currentUnproccessedData,
                                CANVAS_WIDTH,
                                CANVAS_HEIGHT,
                                largeGraphMode,
                                true,
                                false,
                            );
                        }
                },
                    // offsetX and offsetY include the padding of the parent container
                    // 需要加上父级容器的 padding-left 16 与自身偏移量 10
                    offsetX: 16 + 10,
                    // 需要加上父级容器的 padding-top 24 、画布兄弟元素高度、与自身偏移量 10
                    offsetY: 0,
                    // the types of items that allow the menu show up
                    // 在哪些类型的元素上响应
                    itemTypes: ['node', 'edge', 'canvas'],
                });
                const graph = new G6.Graph({
                    container: containerId,
                    width,   //: 800,
                    height,//: 500,
                    // fitView:true, 别开最好
                    //TODO:注意 fitCenter和layout中的center只选择一个
                    // fitCenter: true,
                    modes: {
                        default: ['drag-canvas', 'activate-relations', 'zoom-canvas'],
                    },
                    layout: {
                        type: 'force',
                        linkDistance: 150, //边的长度 180
                        preventOverlap: true,
                        nodeStrength: -170,  //节点的引力，负数代表斥力
                        center: [ 500, 200 ],     // 可选，默认为图的中心
                        // center: [width / 2, height / 2],
                    },
                    defaultNode: {
                        size: 20,
                        type: 'circle',
                        style: {
                            lineWidth: 2,
                        },
                        labelCfg: {
                            position: 'bottom',
                        },
                        icon: {
                            show: true,
                            img: 'https://gw.alipayobjects.com/zos/basement_prod/012bcf4f-423b-4922-8c24-32a89f8c41ce.svg',
                            /* icon's size, 20 * 20 by default: */
                            //   width: 40,
                            //   height: 40
                        },
                    },
                    defaultEdge: {
                        style:{  //TODO:可以修改箭头的样式  https://g6.antv.antgroup.com/manual/middle/elements/edges/arrow
                            endArrow:true
                        }
                    },
                    nodeStateStyles: {
                        activeByLegend: {
                            lineWidth: 10,
                            strokeOpacity: 0.5
                        },
                        inactiveByLegend: {
                            
                        },
                        active: {
                            lineWidth: 10,
                            strokeOpacity: 0.5
                        },
                    },
                    edgeStateStyles: {
                        activeByLegend: {
                            lineWidth: 3
                        },
                        inactiveByLegend: {
                            opacity: 0.5
                        }
                    },
                    animate: true,
                    plugins: [legend,tooltip,contextMenu],
                });
                this.graphCanvas = graph;
  
              
                graph.data({
                    nodes: data.nodes,
                    edges: data.edges.map(function (edge, i) {
                        edge.id = 'edge' + edge.id;
                        return Object.assign({}, edge);
                    }),
                });
                graph.render();
                graph.on('node:dragstart', function (e) {
                    graph.layout();
                        refreshDragedNodePosition(e);
                });
                graph.on('node:drag', function (e) {
                    const forceLayout = graph.get('layoutController').layoutMethods[0];
                    forceLayout.execute();
                    refreshDragedNodePosition(e);
                });
                graph.on('node:dragend', function (e) {
                    e.item.get('model').fx = null;
                    e.item.get('model').fy = null;
                });
                graph.on('afteradditem',function (e) {
                    console.log("after add回调函数")
                    graph.layout();
                    refreshDragedNodePosition(e);
                });

                // graph.on('node:mouseenter', (evt) => {
                // const { item } = evt;
                // graph.setItemState(item, 'active', true);
                // });

                // graph.on('node:mouseleave', (evt) => {
                // const { item } = evt;
                // graph.setItemState(item, 'active', false);
                // });
                if (typeof window !== 'undefined')
                window.onresize = () => {
                    if (!graph || graph.get('destroyed')) return;
                    if (!container || !container.scrollWidth || !container.scrollHeight) return;
                    graph.changeSize(container.scrollWidth, container.scrollHeight);
                };
            });

            function refreshDragedNodePosition(e) {
            const model = e.item.get('model');
            model.fx = e.x;
            model.fy = e.y;
            }
        },
        countGraphType(){
            this.labelCounts = this.graph.nodes.reduce((acc, obj) => {
                const label = obj.label;
                acc[label] = (acc[label] || 0) + 1;
                return acc;
            }, {});
            console.log(this.labelCounts);
        },
        noMoreInfo() {
            this.$notify({
            title: '检索成功',
            message: '该节点暂无更多关联信息',
            type: 'success'
            });
        },
        haveMoreInfo(nodeCount,edgeCount){
            this.$notify({
            title: '检索成功',
            message: '共查到新的节点'+nodeCount+"个,新的关系"+edgeCount+"个",
            type: 'success'
            });
        }
    },
    mounted(){
        // this.showGraph2();
    },
}
</script>

<style scoped>
    .page-container{
        padding: 25px;
    }

    /deep/.el-divider--horizontal {
        display: block;
        height: 1px;
        width: 100%;
        margin: 12px 0;
    }

    .el-row{
        margin-bottom: 20px;
    }

    .el-card{
        border-radius: 14px;
    }

    .card-title{
        font-weight: bold;
        font-size: 16px;
        color: #303133;
        margin-bottom: 20px;
      }
    .graph-container{
        display:flex;
        scrollWidth:400px; 
        scrollHeight:300px;
    }

    .sub-chart{
        height: 380px;
    }

</style>
